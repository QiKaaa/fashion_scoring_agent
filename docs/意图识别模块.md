# 意图识别模块设计文档

## 1. 模块概述

意图识别模块是智能穿搭分析Agent系统的核心组件，负责自动识别用户意图，并将请求路由到相应的服务。该模块基于AutoGen实现，通过提示词工程让大模型判断用户意图类型。

## 2. 设计目标

1. **准确识别用户意图**：精确区分用户是需要穿搭评分还是穿搭推荐
2. **提供置信度评分**：为每次识别结果提供置信度评分，便于系统决策
3. **支持多模态输入**：同时处理文本和图像输入
4. **高效处理请求**：快速响应用户请求，减少等待时间
5. **可扩展性**：支持未来添加更多意图类型

## 3. 意图类型

当前系统支持两种核心意图类型：

1. **outfit_scoring（穿搭评分）**：用户希望对穿搭进行评价、分析或评分
   - 示例："这套穿搭怎么样？"
   - 示例："帮我分析一下这身衣服的搭配"
   - 示例："我这身打几分？"

2. **outfit_recommendation（穿搭推荐）**：用户希望获取穿搭建议、搭配推荐或风格指导
   - 示例："推荐一套适合商务场合的穿搭"
   - 示例："我明天有约会，应该穿什么？"
   - 示例："帮我搭配一套春季的休闲装"

## 4. 技术实现

### 4.1 核心组件

1. **IntentService类**：意图识别服务的主类
2. **AutoGen Agent**：基于AutoGen实现的意图识别Agent
3. **提示词工程**：精心设计的系统提示词，引导大模型进行意图分类
4. **API接口**：提供REST API接口，供外部系统调用

### 4.2 工作流程

1. 接收用户请求（文本消息和/或图像）
2. 构建提示词，包含用户消息和图像描述
3. 调用AutoGen Agent进行意图识别
4. 解析Agent响应，提取意图类型、置信度和推理过程
5. 返回结构化的意图识别结果

### 4.3 提示词设计

系统提示词是意图识别模块的核心，它引导大模型进行准确的意图分类。提示词包含以下关键部分：

1. **角色定义**：明确Agent的角色是意图识别专家
2. **任务描述**：详细说明意图识别任务和支持的意图类型
3. **输出格式**：规定输出必须是JSON格式，包含特定字段
4. **判断标准**：提供明确的判断标准，帮助模型区分不同意图
5. **示例输出**：提供示例输出，展示预期的响应格式

### 4.4 置信度计算

置信度评分（0.0-1.0）反映了模型对意图判断的确信程度：

- **高置信度（0.8-1.0）**：用户意图明确，关键词匹配度高
- **中等置信度（0.5-0.8）**：用户意图相对明确，但可能有一些模糊性
- **低置信度（0.0-0.5）**：用户意图模糊，难以确定

### 4.5 模拟模式

为了支持开发和测试，模块提供了模拟模式，无需调用实际的大模型API：

- **关键词匹配**：基于预定义关键词列表进行简单匹配
- **默认置信度**：根据匹配关键词数量计算置信度
- **快速响应**：立即返回结果，无需等待API调用

## 5. 代码结构

### 5.1 核心文件

- `app/services/intent_service.py`：意图识别服务实现
- `app/api/endpoints/intent.py`：意图识别API端点
- `app/models/schemas.py`：意图识别相关的数据模型

### 5.2 关键类和方法

#### IntentService类

```python
class IntentService:
    """意图识别服务 - 基于AutoGen实现双意图分类"""
    
    def __init__(self):
        """初始化意图识别服务"""
        # 配置LLM
        self.config_list = [...]
        
        # 创建意图识别Agent
        self.intent_agent = autogen.AssistantAgent(...)
        
        # 创建用户代理
        self.user_proxy = autogen.UserProxyAgent(...)
    
    def _get_intent_system_prompt(self) -> str:
        """获取意图识别系统提示词"""
        return """..."""
    
    async def detect_intent(self, request: IntentRequest) -> IntentResponse:
        """检测用户意图"""
        # 实现意图识别逻辑
        
    def _mock_intent_detection(self, request: IntentRequest) -> IntentResponse:
        """模拟意图识别（用于开发测试）"""
        # 实现模拟意图识别逻辑
```

#### 数据模型

```python
class IntentRequest(BaseModel):
    """意图识别请求"""
    message: str
    image_path: Optional[str] = None
    user_id: Optional[str] = None


class IntentResponse(BaseModel):
    """意图识别响应"""
    intent_type: Literal["outfit_scoring", "outfit_recommendation"]
    confidence: float = Field(..., ge=0, le=1)
    reasoning: Optional[str] = None
    raw_content: Optional[str] = None
```

#### API端点

```python
@router.post("/detect", response_model=IntentResponse)
async def detect_intent(
    request: IntentRequest = Body(..., description="意图识别请求")
):
    """
    检测用户意图
    
    根据用户输入的文本和/或图像，判断用户意图是多维度穿搭打分还是穿搭推荐
    """
    try:
        # 调用意图识别服务
        response = await intent_service.detect_intent(request)
        return response
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"意图识别失败: {str(e)}")
```

## 6. 使用示例

### 6.1 Python示例

```python
import requests
import json

# 意图识别请求
data = {
    "message": "这套穿搭怎么样？",
    "image_path": "data/images/outfit1.jpg",
    "user_id": "user123"
}
response = requests.post(
    "http://localhost:8000/api/v1/intent/detect",
    json=data
)

# 打印结果
result = response.json()
print(f"意图类型: {result['intent_type']}")
print(f"置信度: {result['confidence']}")
print(f"推理过程: {result['reasoning']}")
```

### 6.2 JavaScript示例

```javascript
// 意图识别请求
const data = {
  message: "这套穿搭怎么样？",
  image_path: "data/images/outfit1.jpg",
  user_id: "user123"
};

fetch("http://localhost:8000/api/v1/intent/detect", {
  method: "POST",
  headers: {
    "Content-Type": "application/json"
  },
  body: JSON.stringify(data)
})
.then(response => response.json())
.then(result => {
  console.log(`意图类型: ${result.intent_type}`);
  console.log(`置信度: ${result.confidence}`);
  console.log(`推理过程: ${result.reasoning}`);
})
.catch(error => console.error("Error:", error));
```

## 7. 性能优化

为提高意图识别模块的性能和响应速度，采取了以下优化措施：

1. **缓存机制**：对相似请求的结果进行缓存，减少重复API调用
2. **并发处理**：使用异步编程处理并发请求
3. **超时控制**：设置合理的API调用超时时间，避免长时间等待
4. **错误重试**：对临时性错误进行自动重试
5. **模型参数优化**：调整大模型参数，平衡准确性和响应速度

## 8. 未来扩展

意图识别模块计划的未来扩展方向：

1. **多语言支持**：增加对多种语言的支持
2. **更多意图类型**：扩展支持更多细分的意图类型
3. **上下文感知**：考虑对话历史和上下文信息进行意图识别
4. **个性化识别**：基于用户历史行为和偏好调整意图识别策略
5. **混合模型**：结合规则引擎和机器学习模型，提高识别准确率

## 9. 常见问题

### 9.1 意图识别不准确

**问题**：意图识别结果与预期不符
**解决方案**：
1. 使用更明确的语言描述需求
2. 提供更清晰的图像
3. 直接指定使用哪种服务

### 9.2 API调用失败

**问题**：调用意图识别API失败
**解决方案**：
1. 检查API密钥配置
2. 验证网络连接
3. 查看服务器日志获取详细错误信息

### 9.3 响应时间过长

**问题**：意图识别响应时间过长
**解决方案**：
1. 使用模拟模式进行快速测试
2. 检查网络连接和服务器负载
3. 考虑使用更轻量级的模型配置

## 10. 结论

意图识别模块是智能穿搭分析Agent系统的关键组件，通过准确识别用户意图，实现了智能路由和个性化服务。基于AutoGen的实现方案提供了高准确率和良好的扩展性，为系统的整体智能化提供了坚实基础。