# 智能穿搭分析Agent快速入门指南

本指南将帮助您快速上手智能穿搭分析Agent系统，包括环境配置、安装步骤和基本使用方法。

## 1. 系统概述

智能穿搭分析Agent是一个基于Qwen-VL-Chat API和AutoGen的云端穿搭分析系统，能够对用户上传的穿搭照片进行智能分析、多维度评分，并提供个性化的穿搭推荐。

系统使用三个专用Agent协同工作：
- **意图识别Agent**：判断用户需求类型
- **多维度穿搭打分Agent**：分析穿搭并提供评分
- **穿搭推荐Agent**：提供个性化穿搭建议

## 2. 环境要求

- **操作系统**：Windows 10/11、macOS 10.15+、Ubuntu 20.04+
- **Python**：3.10或更高版本
- **数据库**：PostgreSQL 14+（带pgvector扩展）
- **缓存**：Redis 6+
- **依赖管理**：Poetry

## 3. 安装步骤

### 3.1 安装Python 3.10+

#### Windows
1. 访问 [Python官网](https://www.python.org/downloads/)
2. 下载Python 3.10或更高版本
3. 运行安装程序，勾选"Add Python to PATH"
4. 完成安装

#### macOS
```bash
brew install python@3.10
```

#### Ubuntu
```bash
sudo apt update
sudo apt install python3.10 python3.10-venv python3.10-dev
```

### 3.2 安装Poetry

#### Windows
```powershell
(Invoke-WebRequest -Uri https://install.python-poetry.org -UseBasicParsing).Content | python -
```

#### macOS/Linux
```bash
curl -sSL https://install.python-poetry.org | python3 -
```

### 3.3 安装PostgreSQL和pgvector

#### Windows
1. 下载并安装 [PostgreSQL](https://www.postgresql.org/download/windows/)
2. 使用pgAdmin或psql安装pgvector扩展：
```sql
CREATE EXTENSION vector;
```

#### macOS
```bash
brew install postgresql
brew services start postgresql
psql postgres -c 'CREATE EXTENSION vector;'
```

#### Ubuntu
```bash
sudo apt install postgresql postgresql-contrib
sudo -u postgres psql -c 'CREATE EXTENSION vector;'
```

### 3.4 安装Redis

#### Windows
使用WSL2或[Redis Windows版本](https://github.com/tporadowski/redis/releases)

#### macOS
```bash
brew install redis
brew services start redis
```

#### Ubuntu
```bash
sudo apt install redis-server
sudo systemctl start redis-server
```

### 3.5 克隆项目并安装依赖

```bash
# 克隆项目
git clone <repository-url>
cd fashion_scoring_agent

# 安装依赖
poetry install
```

### 3.6 配置环境变量

创建`.env`文件：

```bash
cp .env.example .env
```

编辑`.env`文件，配置以下关键参数：

```
# 数据库配置
POSTGRES_SERVER=localhost
POSTGRES_USER=postgres
POSTGRES_PASSWORD=your_password
POSTGRES_DB=fashion_scoring_agent
POSTGRES_PORT=5432

# Redis配置
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_DB=0
REDIS_PASSWORD=your_redis_password

# Qwen-VL-Chat API配置
QWEN_API_KEY=your_api_key
QWEN_API_BASE=https://dashscope.aliyuncs.com/api/v1
QWEN_MODEL_NAME=qwen-vl-chat
```

### 3.7 初始化数据库

```bash
# 激活虚拟环境
poetry shell

# 初始化数据库
alembic upgrade head
```

## 4. 启动服务

```bash
# 激活虚拟环境
poetry shell

# 启动服务
uvicorn app.main:app --reload
```

服务将在 http://localhost:8000 启动。

## 5. 基本使用

### 5.1 访问API文档

启动服务后，访问以下地址查看API文档：
- Swagger UI: http://localhost:8000/docs
- ReDoc: http://localhost:8000/redoc

### 5.2 使用统一处理接口

统一处理接口是系统的主要入口，它会自动识别用户意图并调用相应的服务。

#### Python示例

```python
import requests
import json

# 上传图像
files = {"file": open("outfit.jpg", "rb")}
data = {"user_id": "user123"}
upload_response = requests.post(
    "http://localhost:8000/api/v1/images/upload",
    files=files,
    data=data
)
image_path = upload_response.json()["image_path"]

# 发送统一请求
data = {
    "message": "这套穿搭怎么样？",
    "image_path": image_path,
    "user_id": "user123",
    "preferences": {
        "preferred_styles": ["休闲", "商务"],
        "preferred_colors": ["蓝色", "黑色", "白色"]
    }
}
response = requests.post(
    "http://localhost:8000/api/v1/unified/process",
    json=data
)

# 打印结果
print(json.dumps(response.json(), indent=2, ensure_ascii=False))
```

#### JavaScript示例

```javascript
// 上传图像
const fileInput = document.querySelector("#fileInput");
const file = fileInput.files[0];
const formData = new FormData();
formData.append("file", file);
formData.append("user_id", "user123");

fetch("http://localhost:8000/api/v1/images/upload", {
  method: "POST",
  body: formData
})
.then(response => response.json())
.then(imageResult => {
  // 发送统一请求
  return fetch("http://localhost:8000/api/v1/unified/process", {
    method: "POST",
    headers: {
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      message: "这套穿搭怎么样？",
      image_path: imageResult.image_path,
      user_id: "user123",
      preferences: {
        preferred_styles: ["休闲", "商务"],
        preferred_colors: ["蓝色", "黑色", "白色"]
      }
    })
  });
})
.then(response => response.json())
.then(result => {
  console.log(result);
  
  // 处理结果
  if (result.intent_type === "outfit_scoring") {
    // 显示穿搭分析结果
    displayAnalysisResult(result.result);
  } else {
    // 显示穿搭推荐结果
    displayRecommendationResult(result.result);
  }
})
.catch(error => console.error("Error:", error));
```

### 5.3 直接使用特定服务

如果您已经知道用户意图，可以直接调用相应的服务API。

#### 穿搭分析API

```python
# 穿搭分析请求
data = {
    "image_path": image_path,
    "user_id": "user123",
    "budget_focus": True,
    "preferences": {
        "preferred_styles": ["休闲", "商务"],
        "preferred_colors": ["蓝色", "黑色", "白色"]
    }
}
response = requests.post(
    "http://localhost:8000/api/v1/analysis/analyze",
    json=data
)

# 打印分析结果
print(json.dumps(response.json(), indent=2, ensure_ascii=False))
```

#### 穿搭推荐API

```python
# 穿搭推荐请求
data = {
    "user_id": "user123",
    "occasion": "商务会议",
    "style_preference": "商务休闲",
    "color_preference": ["蓝色", "灰色", "黑色"],
    "budget_range": {"min": 2000, "max": 5000},
    "season": "春季"
}
response = requests.post(
    "http://localhost:8000/api/v1/recommendations/get",
    json=data
)

# 打印推荐结果
print(json.dumps(response.json(), indent=2, ensure_ascii=False))
```

## 6. 开发模式

### 6.1 使用模拟API

在开发阶段，您可以使用模拟API进行测试，无需实际调用Qwen-VL-Chat API：

```
POST /api/v1/intent/mock-detect
POST /api/v1/unified/mock-process
```

这些端点使用预定义的响应，便于开发和测试。

### 6.2 调试模式

启用调试模式：

```bash
# 设置环境变量
export LOG_LEVEL=DEBUG

# 启动服务
uvicorn app.main:app --reload --log-level debug
```

### 6.3 单元测试

运行单元测试：

```bash
# 激活虚拟环境
poetry shell

# 运行测试
pytest
```

## 7. 常见问题

### 7.1 依赖安装失败

**问题**：安装依赖时出现错误
**解决方案**：
```bash
# 更新Poetry
poetry self update

# 清除缓存
poetry cache clear --all pypi

# 重新安装依赖
poetry install
```

### 7.2 数据库连接失败

**问题**：无法连接到PostgreSQL数据库
**解决方案**：
1. 检查PostgreSQL服务是否运行
2. 验证`.env`文件中的数据库配置
3. 确保用户有权限访问数据库

### 7.3 API密钥配置

**问题**：Qwen-VL-Chat API调用失败
**解决方案**：
1. 检查`.env`文件中的API密钥配置
2. 确保API密钥有效且未过期
3. 验证API基础URL是否正确

### 7.4 图像上传问题

**问题**：图像上传失败
**解决方案**：
1. 确保上传目录存在且有写入权限
2. 检查图像格式是否支持（JPEG、PNG、WebP）
3. 验证图像大小是否超过限制（默认10MB）

## 8. 下一步

完成基本设置和使用后，您可以：

1. **探索高级功能**：查看API文档了解更多功能
2. **自定义系统**：根据需求修改代码和配置
3. **集成到应用**：将API集成到您的应用中
4. **部署到生产环境**：使用Docker或其他工具部署到生产环境

## 9. 资源链接

- [项目文档](./项目文档.md)
- [API使用指南](./API使用指南.md)
- [意图识别模块文档](./意图识别模块.md)
- [GitHub仓库](https://github.com/your-org/fashion-scoring-agent)
- [Qwen-VL-Chat API文档](https://help.aliyun.com/document_detail/2400395.html)
- [AutoGen文档](https://microsoft.github.io/autogen/)