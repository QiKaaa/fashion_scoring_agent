# 智能穿搭分析Agent项目文档

## 1. 项目概述

智能穿搭分析Agent是一个基于Qwen-VL-Chat API和AutoGen的云端穿搭分析系统，采用纯API架构设计，能够对用户上传的穿搭照片进行智能分析、多维度评分，并提供个性化的穿搭推荐。

系统使用三个专用Agent（意图识别、多维度打分、穿搭推荐）协同工作，通过意图识别Agent自动判断用户需求，并调用相应的服务。

## 2. 系统架构

### 2.1 整体架构

```
客户端请求 → FastAPI应用
              ↓
        意图识别Agent → 选择处理流程
         /      \
多维度打分Agent   穿搭推荐Agent
         \      /
     Qwen-VL-Chat API
           ↓
  PostgreSQL + pgvector存储
```

### 2.2 技术栈

- **后端框架**: FastAPI + Python 3.10+
- **AI框架**: AutoGen + Qwen-VL-Chat API
- **数据库**: PostgreSQL + pgvector
- **缓存**: Redis
- **图像处理**: Pillow 11.0.0+ + OpenCV
- **依赖管理**: Poetry

### 2.3 核心组件

1. **意图识别Agent**: 基于AutoGen实现，负责判断用户意图是多维度穿搭打分还是穿搭推荐
2. **多维度穿搭打分Agent**: 基于AutoGen实现，负责分析穿搭并提供多维度评分
3. **穿搭推荐Agent**: 基于AutoGen实现，负责提供个性化穿搭建议
4. **统一处理接口**: 自动识别用户意图，并调用相应的服务
5. **图像处理服务**: 负责图像上传、预处理和优化
6. **数据模型**: 定义系统中的各种数据结构和验证规则

## 3. 目录结构

```
fashion_scoring_agent/
├── app/                    # 应用核心代码
│   ├── api/               # API路由
│   │   ├── endpoints/     # API端点
│   │   │   ├── intent.py  # 意图识别API
│   │   │   ├── unified.py # 统一处理API
│   │   │   └── ...
│   │   └── api.py         # API路由配置
│   ├── core/              # 核心业务逻辑
│   │   ├── config.py      # 应用配置
│   │   └── ...
│   ├── models/            # 数据模型
│   │   ├── schemas.py     # Pydantic模型
│   │   └── ...
│   ├── services/          # 服务层
│   │   ├── intent_service.py    # 意图识别服务
│   │   ├── scoring_agent.py     # 多维度打分Agent
│   │   ├── recommendation_service.py # 推荐服务
│   │   ├── analysis_service.py  # 分析服务
│   │   ├── image_service.py     # 图像服务
│   │   └── ...
│   ├── utils/             # 工具函数
│   └── ml/                # 机器学习模块
├── data/                  # 数据存储
│   ├── models/            # 预训练模型
│   ├── embeddings/        # 向量数据
│   └── images/            # 图像存储
├── tests/                 # 测试用例
├── docs/                  # 文档
├── requirements/          # 依赖文件
└── pyproject.toml         # Poetry配置
```

## 4. 核心功能详解

### 4.1 意图识别模块

意图识别模块基于AutoGen实现，负责判断用户意图是多维度穿搭打分还是穿搭推荐。

**核心文件**:
- `app/services/intent_service.py`: 意图识别服务
- `app/api/endpoints/intent.py`: 意图识别API端点

**功能特点**:
- 支持两种意图类型：多维度穿搭打分、穿搭推荐
- 使用结构化提示词引导大模型进行意图分类
- 提供置信度评分和推理过程解释
- 支持文本+图像的多模态输入

**API接口**:
- `POST /api/v1/intent/detect`: 检测用户意图
- `POST /api/v1/intent/mock-detect`: 模拟检测用户意图（开发测试用）

### 4.2 多维度穿搭打分Agent

多维度穿搭打分Agent基于AutoGen实现，负责分析穿搭并提供多维度评分。

**核心文件**:
- `app/services/scoring_agent.py`: 多维度穿搭打分Agent
- `app/services/analysis_service.py`: 穿搭分析服务

**评分维度**:
- 颜色搭配协调性
- 风格协调性
- 场合适宜性
- 时尚度
- 个人特色
- 预算合理性（可选）

**输出内容**:
- 穿搭详细描述
- 颜色搭配分析
- 风格类型识别
- 多维度评分（1-10分）
- 总体评价
- 改进建议

### 4.3 穿搭推荐Agent

穿搭推荐Agent基于AutoGen实现，负责提供个性化穿搭建议。

**核心文件**:
- `app/services/recommendation_service.py`: 穿搭推荐Agent

**推荐内容**:
- 具体单品推荐（上衣、下装、鞋履、配饰等）
- 风格描述
- 场合适宜性
- 预算估计
- 搭配技巧

**个性化因素**:
- 用户偏好
- 场合需求
- 季节适应性
- 预算范围
- 参考图片

### 4.4 统一处理接口

统一处理接口自动识别用户意图，并调用相应的服务。

**核心文件**:
- `app/api/endpoints/unified.py`: 统一处理API端点

**处理流程**:
1. 接收用户请求（文本+图像）
2. 调用意图识别Agent判断用户意图
3. 根据意图调用相应的服务（多维度穿搭打分或穿搭推荐）
4. 返回处理结果

**API接口**:
- `POST /api/v1/unified/process`: 统一处理请求
- `POST /api/v1/unified/mock-process`: 模拟统一处理请求（开发测试用）

## 5. 数据模型

系统使用Pydantic定义了一系列数据模型，用于请求验证和响应格式化。

**核心数据模型**:

1. **意图识别**:
   - `IntentRequest`: 意图识别请求
   - `IntentResponse`: 意图识别响应

2. **用户偏好**:
   - `UserPreferences`: 用户偏好设置

3. **穿搭分析**:
   - `OutfitAnalysisRequest`: 穿搭分析请求
   - `ScoreDimension`: 评分维度
   - `OutfitAnalysisResponse`: 穿搭分析响应

4. **穿搭推荐**:
   - `RecommendationRequest`: 穿搭推荐请求
   - `OutfitItem`: 穿搭单品
   - `OutfitRecommendation`: 穿搭推荐

5. **统一处理**:
   - `UnifiedRequest`: 统一处理请求
   - `UnifiedResponse`: 统一处理响应

## 6. 配置说明

系统配置通过环境变量和`.env`文件进行管理。

**核心配置项**:

1. **应用配置**:
   - `APP_NAME`: 应用名称
   - `APP_VERSION`: 应用版本
   - `API_V1_STR`: API版本前缀

2. **安全配置**:
   - `SECRET_KEY`: 密钥
   - `ACCESS_TOKEN_EXPIRE_MINUTES`: 访问令牌过期时间

3. **数据库配置**:
   - `POSTGRES_SERVER`: PostgreSQL服务器地址
   - `POSTGRES_USER`: PostgreSQL用户名
   - `POSTGRES_PASSWORD`: PostgreSQL密码
   - `POSTGRES_DB`: PostgreSQL数据库名
   - `POSTGRES_PORT`: PostgreSQL端口

4. **Redis配置**:
   - `REDIS_HOST`: Redis服务器地址
   - `REDIS_PORT`: Redis端口
   - `REDIS_DB`: Redis数据库索引
   - `REDIS_PASSWORD`: Redis密码

5. **Qwen-VL-Chat API配置**:
   - `QWEN_API_KEY`: Qwen-VL-Chat API密钥
   - `QWEN_API_BASE`: Qwen-VL-Chat API基础URL
   - `QWEN_MODEL_NAME`: Qwen-VL-Chat模型名称

6. **文件存储配置**:
   - `UPLOAD_DIR`: 上传目录
   - `MAX_UPLOAD_SIZE`: 最大上传大小
   - `ALLOWED_IMAGE_TYPES`: 允许的图像类型

## 7. 部署指南

### 7.1 环境要求

- Python 3.10+
- PostgreSQL 14+ (with pgvector extension)
- Redis 6+
- Poetry

### 7.2 安装步骤

1. **克隆项目**
```bash
git clone <repository-url>
cd fashion_scoring_agent
```

2. **安装依赖**
```bash
poetry install
```

3. **配置环境变量**
```bash
cp .env.example .env
# 编辑 .env 文件，配置数据库和API密钥
```

4. **初始化数据库**
```bash
poetry run alembic upgrade head
```

5. **启动服务**
```bash
poetry run uvicorn app.main:app --reload
```

### 7.3 Docker部署

1. **构建Docker镜像**
```bash
docker build -t fashion-scoring-agent .
```

2. **运行Docker容器**
```bash
docker run -p 8000:8000 fashion-scoring-agent
```

## 8. API文档

启动服务后，访问以下地址查看API文档：
- Swagger UI: http://localhost:8000/docs
- ReDoc: http://localhost:8000/redoc

### 8.1 核心API端点

1. **意图识别**
```
POST /api/v1/intent/detect
```

2. **统一处理接口**
```
POST /api/v1/unified/process
```

3. **穿搭分析**
```
POST /api/v1/analysis/analyze
```

4. **穿搭推荐**
```
POST /api/v1/recommendations/get
```

## 9. 开发指南

### 9.1 代码规范

- 使用 Black 进行代码格式化
- 使用 isort 进行导入排序
- 使用 mypy 进行类型检查
- 使用 pytest 进行单元测试

### 9.2 运行测试

```bash
poetry run pytest
```

### 9.3 代码检查

```bash
poetry run black .
poetry run isort .
poetry run mypy .
```

## 10. 未来计划

1. **Agent长期记忆管理模块**
   - 实现上下文连贯性和历史信息调用
   - 支持用户偏好的长期学习和演进

2. **用户偏好学习和风格画像构建模块**
   - 基于用户历史交互构建风格画像
   - 实现风格偏好的自动学习和更新

3. **向量相似度搜索**
   - 使用pgvector实现穿搭风格相似度搜索
   - 支持"查找类似风格"功能

4. **个性化推荐引擎**
   - 基于用户画像的个性化推荐算法
   - 支持季节、场合、预算等多因素推荐

## 11. 常见问题

### 11.1 API调用失败

**问题**: API调用返回500错误
**解决方案**: 检查Qwen-VL-Chat API密钥是否正确配置，查看日志获取详细错误信息

### 11.2 图像上传失败

**问题**: 图像上传失败或无法处理
**解决方案**: 确保图像格式符合要求（JPEG、PNG、WebP），大小不超过10MB

### 11.3 意图识别不准确

**问题**: 意图识别结果不符合预期
**解决方案**: 使用更明确的语言描述需求，或直接指定使用哪种服务

## 12. 联系方式

如有问题或建议，请提交Issue或联系开发团队。